<head>

<style>
.toggler {cursor: hand}
.line.visited {background: yellow}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script>
// var call_map = {{..}};
// var visited_lines = {{visited_lines}};
</script>


<script>

/*
function bind_toggler_to_inlined(call_id){
    $toggler = $("#toggler_"+call_id) .off("click") .on("click",  smart_toggle );
}

    
function init_togglers(){
   $(".toggler").each( function(){ 
    
     var id = this.id;
     var call_id = id.substr(  "toggler_".length );
     bind_toggler_to_inlined( call_id );
    });
    
}
*/

$(document).ready(function(){

    
   // jQuery methods go here...
   $(".inlined").hide();
   
   $first_code =  $("#codes .code").first();
    
   $("#trace").prepend( $first_code.prop('outerHTML')    );
   
   $(".line.visited").each(
        function(){  
            this.title = this.id;
    });
   
   // init_togglers();

});

// //should apply it iterating over call_map
// function inject_toggler( line_id, call_id ){
   
    
// }

// inject_toggler("__main__:332", "__main__:A"); // TEST

function smart_toggle( toggler ){

        toggler = (typeof toggler !== 'undefined') ?  toggler : this;   // defaults to "this" -- element calling the function
        
        $toggler = $(toggler);
        
        var id = toggler.id;
        call_id = id.substr(  "toggler_".length );

        // get corresponding closest container?
        var $target = $toggler.siblings("#inlined_"+call_id).first();
        if ($target.is(":visible")) $target.hide();
        else show_inlined($target);
    
}

// function show_inlined(callee_line_id, call_id){
    // $line = $("#lineID_"+callee_line_id).first();
    // $line.children(...)
function show_inlined($container){
    
    var id = $container.prop('id');
    var call_id = id.substr(  "inlined_".length );
 
    var $code = $("#code_"+call_id).first();  // take from #codes list
    
    if($container.text().trim()=="") // if empty
    {
        $container.append(  $code.html() );
    }
        
    $container.show();
}

</script>

</head>

<body>

<h2>call_map:</h2>
<pre>
{{call_map}}
</pre>

<h2>visited_lines:</h2>
<pre>
{{visited_lines}}
</pre>

<h2>Trace:</h2>
<div id="trace">



<pre>

<span class="line">bla bla
</span>

<span class="line calee" id="lineID_mymodule_123">boo boo 
<span class="toggler" id="toggler_X">*</span> 
<span class="toggler" id="toggler_____main__-Z">*</span>
<span class="toggler" id="toggler_Y">*</span> 

<span class="inlined" id="inlined_____main__-Z"></span>
<span class="inlined" id="inlined_X"></span>
<span class="inlined" id="inlined_Y">.Y.</span>
</span>

</div>


    <h2>Codes</h2>
<div id="codes">
{{codes}}


<pre id="code_X">asdf</pre>
<pre id="code_____main__-Z">code_____main__-Z</pre>

</div>


</body>
